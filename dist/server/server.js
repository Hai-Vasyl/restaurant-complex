(()=>{"use strict";var e={n:r=>{var t=r&&r.__esModule?()=>r.default:()=>r;return e.d(t,{a:t}),t},d:(r,t)=>{for(var n in t)e.o(t,n)&&!e.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:t[n]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)};const r=require("@babel/runtime/regenerator");var t=e.n(r);const n=require("@babel/runtime/helpers/asyncToGenerator");var s=e.n(n);const a=require("express");var o=e.n(a);const c=require("mongoose");var u=e.n(c);const i=require("body-parser");var p=e.n(i);const d=require("express-validator"),l=require("@babel/runtime/helpers/defineProperty");var f=e.n(l),m=new c.Schema({username:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},ava:{type:String,required:!0,default:"https://www.pngkey.com/png/detail/114-1149878_setting-user-avatar-in-specific-size-without-breaking.png"},firstname:{type:String,default:""},lastname:{type:String,default:""},phone:{type:String,default:""},bio:{type:String,default:""},birth:{type:Date,default:""},role:{type:String,required:!0,default:"user",enum:["user","admin"]},date:{type:Date,required:!0}});const v=(0,c.model)("User",m);var g=new c.Schema({title:{type:String,required:!0},location:{type:String,required:!0},description:{type:String,required:!0},food:{type:String,required:!0},servicesIncluded:{type:String,required:!0},services:{type:String,required:!0},entertainment:{type:String,required:!0},contacts:{type:String,required:!0},road:{type:String,required:!0}});const h=(0,c.model)("HRcomplex",g);var y=new c.Schema({path:{type:String,required:!0},hrComplex:{type:c.Types.ObjectId,ref:"HRcomplex",required:!0},title:{type:String,default:""},description:{type:String,default:""}});const b=(0,c.model)("Image",y);var x=new c.Schema({settlement:{type:Date,required:!0},eviction:{type:Date,required:!0},hrComplex:{type:c.Types.ObjectId,ref:"HRcomplex",required:!0},booked:{type:Boolean,required:!0,default:!1},price:{type:Number,required:!0}});const w=(0,c.model)("DateRange",x);var k=new c.Schema({buyer:{type:c.Types.ObjectId,ref:"User",required:!0},hrComplex:{type:c.Types.ObjectId,ref:"HRcomplex",required:!0},price:{type:Number,required:!0},settlement:{type:Date,required:!0},eviction:{type:Date,required:!0},date:{type:Date,required:!0}});const j=(0,c.model)("Order",k);var O=new c.Schema({hrComplex:{type:c.Types.ObjectId,ref:"HRcomplex",required:!0},owner:{type:c.Types.ObjectId,ref:"User",required:!0},content:{type:String,required:!0},date:{type:Date,required:!0},response:{type:c.Types.ObjectId,ref:"Response"}});const q=(0,c.model)("Response",O),S=require("bcrypt");var D=e.n(S);const I=require("jsonwebtoken");var R=e.n(I);const C=require("dotenv");function P(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function _(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?P(Object(t),!0).forEach((function(r){f()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):P(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}(0,C.config)();var E=process.env.JWT_SECRET,T=function(){var e=s()(t().mark((function e(r,n,s){var a,o,c,u,i,p,d,l=arguments;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=l.length>3&&void 0!==l[3]&&l[3],o=a?{_id:{$ne:s},username:r}:{username:r},c=a?{_id:{$ne:s},email:n}:{email:n},e.next=5,v.findOne(o);case 5:return u=e.sent,e.next=8,v.findOne(c);case 8:if(i=e.sent,p=u&&Object.values(u).length,d=i&&Object.values(i).length,!p||!d){e.next=15;break}return e.abrupt("return",{errors:[{msg:"Ім'я користувача не унікальне!",param:"username"},{msg:"Електронна пошта не є унікальною!",param:"email"}]});case 15:if(!p){e.next=19;break}return e.abrupt("return",{errors:[{msg:"Користувач з цим іменем користувача вже існує!",param:"username"}]});case 19:if(!d){e.next=21;break}return e.abrupt("return",{errors:[{msg:"Користувач з цією електронною поштою вже існує!",param:"email"}]});case 21:case"end":return e.stop()}}),e)})));return function(r,t,n){return e.apply(this,arguments)}}(),M=function(){var e=s()(t().mark((function e(r,n){var s,a,o,c,u,i,p,l,f,m,g,h;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(s=(0,d.validationResult)(r)).isEmpty()){e.next=4;break}return e.abrupt("return",n.status(400).json({errors:s.array()}));case 4:return a=r.body,o=a.username,c=a.email,u=a.password,i=a.role,p=a.ava,e.next=7,T(o,c);case 7:return(l=e.sent)&&l.errors&&l.errors.length&&n.staus(400).json(l),e.next=11,D().hash(u,12);case 11:return f=e.sent,m=new v({username:o,email:c,role:i,password:f,ava:p,date:new Date}),e.next=15,m.save();case 15:g=e.sent,h=R().sign({userId:g._id},E),n.status(201).json({token:h,user:g}),e.next=23;break;case 20:e.prev=20,e.t0=e.catch(0),n.status(400).json("Register user error: ".concat(e.t0.message));case 23:case"end":return e.stop()}}),e,null,[[0,20]])})));return function(r,t){return e.apply(this,arguments)}}(),A=function(){var e=s()(t().mark((function e(r,n){var s,a,o,c,u,i;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(s=(0,d.validationResult)(r)).isEmpty()){e.next=4;break}return e.abrupt("return",n.status(400).json({errors:s.array()}));case 4:return a=r.body,o=a.email,c=a.password,e.next=7,v.findOne({email:o});case 7:if(u=e.sent,u&&Object.values(u).length){e.next=11;break}return e.abrupt("return",n.status(400).json({errors:[{msg:"Користувач з цією електронною поштою не існує!",param:"email"}]}));case 11:return e.next=13,D().compare(c,u.password);case 13:if(e.sent){e.next=16;break}return e.abrupt("return",n.status(400).json({errors:[{msg:"Пароль не правильний, спробуйте ще раз!",param:"password"}]}));case 16:i=R().sign({userId:u._id},E),n.status(201).json({token:i,user:u}),e.next=23;break;case 20:e.prev=20,e.t0=e.catch(0),n.status(400).json("Login user error: ".concat(e.t0.message));case 23:case"end":return e.stop()}}),e,null,[[0,20]])})));return function(r,t){return e.apply(this,arguments)}}(),B=function(){var e=s()(t().mark((function e(r,n){var s,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params.userId,e.next=4,v.findById(s).select("-password");case 4:a=e.sent,n.json(a),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n.status(400).json("Getting user info error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(r,t){return e.apply(this,arguments)}}(),U=function(){var e=s()(t().mark((function e(r,n){var s,a,o,c,u,i,p,l,f,m,g,h,y,b,x;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(s=(0,d.validationResult)(r)).isEmpty()){e.next=4;break}return e.abrupt("return",n.status(400).json({errors:s.array()}));case 4:return a=r.body,o=a.username,c=a.email,u=a.firstname,i=a.lastname,p=a.phone,l=a.bio,f=a.birth,m=a.password,g=r.userId,e.next=8,T(o,c,g,!0);case 8:if(!((h=e.sent)&&h.errors&&h.errors.length)){e.next=11;break}return e.abrupt("return",n.status(400).json(h));case 11:if(y={username:o,email:c,firstname:u,lastname:i,phone:p,bio:l,birth:f,date:new Date},void 0===m){e.next=17;break}return e.next=15,D().hash(m,12);case 15:b=e.sent,y=_(_({},y),{},{password:b});case 17:return e.next=19,v.findByIdAndUpdate(g,_({},y));case 19:return e.next=21,v.findById(g);case 21:x=e.sent,n.json(x),e.next=28;break;case 25:e.prev=25,e.t0=e.catch(0),n.status(400).json("Updating user info error: ".concat(e.t0.message));case 28:case"end":return e.stop()}}),e,null,[[0,25]])})));return function(r,t){return e.apply(this,arguments)}}(),G=function(){var e=s()(t().mark((function e(r,n){var s;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,v.find().select("username email ava role date");case 3:s=e.sent,n.json(s),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),n.status(400).json("Getting all users error: ".concat(e.t0.message));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(r,t){return e.apply(this,arguments)}}();(0,C.config)();var L=process.env.JWT_SECRET;const H=function(){var e=s()(t().mark((function e(r,n,s){var a,o,c,u;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"OPTIONS"!==r.method){e.next=3;break}return e.abrupt("return",s());case 3:if(a=r.headers.authorization){e.next=6;break}return e.abrupt("return",n.status(401).json("Access denied!"));case 6:if(o=a.split(" ")[1]){e.next=9;break}return e.abrupt("return",n.status(401).json("Access denied!"));case 9:if(c=R().verify(o,L),u=c.userId){e.next=12;break}return e.abrupt("return",n.status(401).json("Access denied!"));case 12:r.userId=u,s(),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),n.status(401).json("Access denied, error: ".concat(e.t0.message));case 19:case"end":return e.stop()}}),e,null,[[0,16]])})));return function(r,t,n){return e.apply(this,arguments)}}();var N=(0,a.Router)();N.post("/register",[(0,d.check)("username").isLength({min:4,max:15}).withMessage("Ім'я користувача має містити щонайменше від 4 до 15 символів!"),(0,d.check)("email").isEmail().withMessage("Електронна адреса неправильна!"),(0,d.check)("password").isLength({min:3,max:25}).withMessage("Пароль повинен містити принаймні від 3 до 25 символів!")],M),N.post("/login",[(0,d.check)("email").isEmail().withMessage("Електронна адреса неправильна!"),(0,d.check)("password").isLength({min:3,max:25}).withMessage("Пароль повинен містити принаймні від 3 до 25 символів!")],A),N.get("/get-info/:userId",B),N.post("/update-user-password",H,[(0,d.check)("username").isLength({min:4,max:15}).withMessage("Ім'я користувача має містити щонайменше від 4 до 15 символів!"),(0,d.check)("email").isEmail().withMessage("Електронна адреса неправильна!"),(0,d.check)("password").isLength({min:3,max:25}).withMessage("Пароль повинен містити принаймні від 3 до 25 символів!")],U),N.post("/update-user",H,[(0,d.check)("username").isLength({min:4,max:15}).withMessage("Ім'я користувача має містити щонайменше від 4 до 15 символів!"),(0,d.check)("email").isEmail().withMessage("Електронна адреса неправильна!")],U),N.get("/users",G);const W=N;var K=function(){var e=s()(t().mark((function e(r,n){var s,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.body.hrComplex,e.next=4,w.find({hrComplex:s});case 4:a=e.sent,n.json(a),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n.status(400).json("Getting DateRanges error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(r,t){return e.apply(this,arguments)}}(),z=function(){var e=s()(t().mark((function e(r,n){var s,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=new w(r.body),e.next=4,s.save();case 4:a=e.sent,n.status(201).json({dateRange:a}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n.status(400).json("Creating DateRange error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(r,t){return e.apply(this,arguments)}}(),J=function(){var e=s()(t().mark((function e(r,n){var s;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params.dateId,e.next=4,w.findByIdAndDelete(s);case 4:n.json({message:"Date range deleted successfully"}),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),n.status(400).json("Deleting DateRange error: ".concat(e.t0.message));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(r,t){return e.apply(this,arguments)}}(),$=function(){var e=s()(t().mark((function e(r,n){var s,a,o,c,u,i,p,d,l,f,m,g,h,y;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.body,a=s.dates,o=s.hrComplex,c=s.user,u=c.firstname,i=c.lastname,p=c.phone,d=r.userId,e.next=5,w.find({hrComplex:o});case 5:return l=e.sent,e.next=8,v.updateOne({_id:d},{firstname:u,lastname:i,phone:p});case 8:for(f=!1,m=0;m<l.length;m++)for(g=0;g<a.length;g++)l[m]._id===a[g]._id&&l[m].booked&&(f=!0,a[g].booked=!0);if(!f){e.next=12;break}return e.abrupt("return",n.json({dates:a,message:"Один або більше діапазонів дат вже заброньовані!"}));case 12:h=0;case 13:if(!(h<a.length)){e.next=22;break}return e.next=16,w.findByIdAndUpdate(a[h]._id,{booked:!0});case 16:return y=new j({buyer:d,hrComplex:o,price:a[h].price,settlement:a[h].settlement,eviction:a[h].eviction,date:new Date}),e.next=19,y.save();case 19:h++,e.next=13;break;case 22:n.json({message:"Date range updated successfully"}),e.next=28;break;case 25:e.prev=25,e.t0=e.catch(0),n.status(400).json("Booking DateRange error: ".concat(e.t0.message));case 28:case"end":return e.stop()}}),e,null,[[0,25]])})));return function(r,t){return e.apply(this,arguments)}}(),F=function(){var e=s()(t().mark((function e(r,n){var s,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.userId,e.next=4,j.find({buyer:s});case 4:a=e.sent,n.json(a),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n.status(400).json("Getting ordered DateRange error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(r,t){return e.apply(this,arguments)}}(),Q=(0,a.Router)();Q.post("/all",K),Q.post("/create-date-range",H,z),Q.delete("/delete-date-range/:dateId",H,J),Q.post("/booking",H,$),Q.post("/ordered",H,F);const V=Q;var X=function(){var e=s()(t().mark((function e(r,n){var s,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=new h(r.body),e.next=4,s.save();case 4:a=e.sent,n.status(201).json(a._id),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n.status(400).json("Creating HRcomplex error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(r,t){return e.apply(this,arguments)}}(),Y=function(){var e=s()(t().mark((function e(r,n){var s;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,h.findById(r.body.hrComplex);case 3:s=e.sent,n.status(200).json(s),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),n.status(400).json("Getting HRcomplex error: ".concat(e.t0.message));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(r,t){return e.apply(this,arguments)}}(),Z=(0,a.Router)();Z.post("/create-hrc",X),Z.post("/get-info",Y);const ee=Z,re=require("aws-sdk");var te=e.n(re);const ne=require("uuid");(0,C.config)();var se=process.env,ae=se.AWS_ID,oe=se.AWS_SECRET,ce=se.AWS_BUCKET,ue=new(te().S3)({accessKeyId:ae,secretAccessKey:oe}),ie=function(){var e=s()(t().mark((function e(r,n){var a,o,c,u,i,p,d,l;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{a=r.file,o=r.body,c=o.hrComplex,u=o.title,i=o.description,p=a.originalname.split("."),d=p[p.length-1],l={Bucket:ce,Key:"".concat((0,ne.v4)(),".").concat(d),Body:a.buffer},ue.upload(l,function(){var e=s()(t().mark((function e(r,s){var a,o;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r&&n.status(400).json("Uploading file error: ".concat(r.message)),a=new b({path:s.Location,hrComplex:c,title:u,description:i}),e.next=4,a.save();case 4:o=e.sent,n.status(200).send(o);case 6:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}())}catch(e){n.json("Upload image error: ".concat(e.message))}case 1:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),pe=function(){var e=s()(t().mark((function e(r,n){var s;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params.key,e.next=4,ue.deleteObject({Key:s,Bucket:ce}).promise();case 4:return e.abrupt("return",{});case 7:e.prev=7,e.t0=e.catch(0),n.json("Upload image error: ".concat(e.t0.message));case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(r,t){return e.apply(this,arguments)}}(),de=function(){var e=s()(t().mark((function e(r,n){var s,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.body.hrComplex,e.next=4,b.find({hrComplex:s});case 4:a=e.sent,n.json(a),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n.json("Getting image error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(r,t){return e.apply(this,arguments)}}();const le=require("multer");var fe=e.n(le),me=(0,a.Router)(),ve=fe().memoryStorage(),ge=fe()({storage:ve}).single("image");me.post("/upload-image",H,ge,ie),me.delete("/delete-image/:key",H,pe),me.post("/all",de);const he=me,ye=require("@babel/runtime/helpers/toConsumableArray");var be=e.n(ye);function xe(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function we(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?xe(Object(t),!0).forEach((function(r){f()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):xe(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var ke=function(){var e=s()(t().mark((function e(r,n){var s,a,o,c,u,i,p;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.userId,a=r.body,o=a.hrComplex,c=a.content,u=a.response,i=new q({hrComplex:o,owner:s,content:c,date:new Date,response:u}),e.next=6,i.save();case 6:p=e.sent,n.status(201).json(p),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),n.status(400).json("Creating response error: ".concat(e.t0.message));case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(r,t){return e.apply(this,arguments)}}(),je=function(){var e=s()(t().mark((function e(r,n){var s,a,o,c,u;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.body.hrComplex,e.next=4,q.find({hrComplex:s,response:null}).populate({path:"owner",select:"username ava role"}).sort({date:-1});case 4:a=e.sent,o=be()(a),c=0;case 7:if(!(c<o.length)){e.next=15;break}return e.next=10,q.find({response:o[c]._id}).populate({path:"owner",select:"username ava role"}).sort({date:-1});case 10:u=e.sent,o[c]=we(we({},o[c]._doc),{},{answers:u});case 12:c++,e.next=7;break;case 15:n.json(o),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(0),n.status(400).json("Getting responses error: ".concat(e.t0.message));case 21:case"end":return e.stop()}}),e,null,[[0,18]])})));return function(r,t){return e.apply(this,arguments)}}(),Oe=function(){var e=s()(t().mark((function e(r,n){var s,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params.responseId,a=r.userId,e.next=5,q.findOneAndDelete({_id:s,owner:a});case 5:n.json({message:"Response deleted successfully!"}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n.status(400).json("Deleting response error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(r,t){return e.apply(this,arguments)}}(),qe=(0,a.Router)();qe.post("/create",H,ke),qe.post("/get-all",je),qe.delete("/delete/:responseId",H,Oe);const Se=qe,De=require("cors");var Ie=e.n(De);(0,C.config)();var Re=process.env,Ce=Re.PORT,Pe=Re.MONGO_USER,_e=Re.MONGO_PASS,Ee=Re.MONGO_DB;s()(t().mark((function e(){var r;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(r=o()()).use(Ie()()),r.use(p().urlencoded({extended:!1})),r.use(p().json()),e.next=7,u().connect("mongodb+srv://".concat(Pe,":").concat(_e,"@cluster0.osxef.mongodb.net/").concat(Ee,"?retryWrites=true&w=majority"),{useCreateIndex:!0,useNewUrlParser:!0,useUnifiedTopology:!0,useFindAndModify:!1},(function(){return console.log("MongoDB successfully connected!")}));case 7:r.use("/auth",W),r.use("/daterange",V),r.use("/hrcomplex",ee),r.use("/image",he),r.use("/response",Se),r.use(o().static("dist/client")),r.listen(Ce,(function(){return console.log("Server started on port: ".concat(Ce))})),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),console.error("Server error: ".concat(e.t0.message));case 19:case"end":return e.stop()}}),e,null,[[0,16]])})))()})();